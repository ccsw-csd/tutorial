
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.9">
    
    
      
        <title>Anexo. Funcionamiento JPA - Tutorial Springboot - Angular</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2b4465f4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/style.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#funcionamiento-spring-jpa" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../.." title="Tutorial Springboot - Angular" class="md-header__button md-logo" aria-label="Tutorial Springboot - Angular" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Tutorial Springboot - Angular
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Anexo. Funcionamiento JPA
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Tutorial Springboot - Angular" class="md-nav__button md-logo" aria-label="Tutorial Springboot - Angular" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Tutorial Springboot - Angular
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Bienvenido!
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../thanks/" class="md-nav__link">
        Agradecimientos!
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../usecases/" class="md-nav__link">
        Contexto de la aplicación
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../install/" class="md-nav__link">
        Entorno de desarrollo
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../create/" class="md-nav__link">
        Creación de proyecto
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../cleancode/" class="md-nav__link">
        Estructura y Clean Code
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../develop/step1/" class="md-nav__link">
        Code: Desarrollo con Angular
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../develop/step2/" class="md-nav__link">
        Code: Desarrollo con Springboot
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../develop/step3/" class="md-nav__link">
        Code: Conectar front con back
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../develop/step4/" class="md-nav__link">
        Code: Listado paginado
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../develop/step5/" class="md-nav__link">
        Code: Listado filtrado
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../exercise/" class="md-nav__link">
        Ahora hazlo tu!
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../git/" class="md-nav__link">
        Anexo. Tutorial básico de Git
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../rest/" class="md-nav__link">
        Anexo. Detalle REST
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tdd/" class="md-nav__link">
        Anexo. TDD
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Anexo. Funcionamiento JPA
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Anexo. Funcionamiento JPA
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#functionamiento-basico" class="md-nav__link">
    Functionamiento básico
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#derived-query-methods" class="md-nav__link">
    Derived Query Methods
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anotacion-query" class="md-nav__link">
    Anotación @Query
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acelerando-las-consultas" class="md-nav__link">
    Acelerando las consultas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alternativa-de-streams" class="md-nav__link">
    Alternativa de Streams
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#repository-custom" class="md-nav__link">
    Repository Custom
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../develop/step6/" class="md-nav__link">
        Anexo. Validaciones (TBC)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../develop/step7/" class="md-nav__link">
        Anexo. Crear Login (TBC)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../styles/" class="md-nav__link">
        Anexo. Estilos (TBC)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../dates/" class="md-nav__link">
        Anexo. Fechas (TBC)
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#functionamiento-basico" class="md-nav__link">
    Functionamiento básico
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#derived-query-methods" class="md-nav__link">
    Derived Query Methods
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anotacion-query" class="md-nav__link">
    Anotación @Query
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acelerando-las-consultas" class="md-nav__link">
    Acelerando las consultas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alternativa-de-streams" class="md-nav__link">
    Alternativa de Streams
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#repository-custom" class="md-nav__link">
    Repository Custom
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="funcionamiento-spring-jpa">Funcionamiento Spring JPA</h1>
<div class="admonition warning">
<p class="admonition-title">Atención</p>
<p>Esta sección está incompleta, faltan algunos puntos por desarrollar. Puedes leer los puntos que ya estén cerrados pero te recomendamos volver a visitarla una vez esté terminada por completo.</p>
</div>
<p>Este anexo no pretende explicar el funcionamiento interno de Spring JPA, simplemente conocer un poco como utilizarlo y algunos pequeños tips que pueden ser interesantes.</p>
<h2 id="functionamiento-basico">Functionamiento básico</h2>
<p>Lo primero que deberías tener claro, es que hagas lo que hagas, al final todo termina lanzando una query nativa sobre la BBDD. Da igual que uses cualquier tipo de <em>acelerador</em> (luego veremos alguno), ya que al final Spring JPA termina convirtiendo lo que hayas programado en una query nativa.</p>
<p>Cuanta más información le proporciones a Spring JPA, tendrás más control sobre la query final, pero más dificil será de mantener. Lo mejor es utilizar, siempre que se pueda, todos los automatismos y automagias posibles y dejar que Spring haga su faena. Habrá ocasiones en que esto no nos sirva, en ese momento tendremos que decidir si queremos bajar el nivel de implementación o queremos utilizar otra alternativa como procesos por streams.</p>
<h2 id="derived-query-methods">Derived Query Methods</h2>
<p>Para la realización de consultas a la base de datos, Spring JPA nos ofrece un sencillo mecanismo que consiste en crear definiciones de métodos con una sintaxis especifica, para luego traducirlas automáticamente a consultas nativas, por parte de Spring JPA.</p>
<p>Esto es muy útil ya que convierte a la aplicación en agnósticos de la tecnología de BBDD utilizada y podemos migrar con facilidad entre las muchas soluciones disponibles en el mercado, delegando esta tarea en Spring.</p>
<p>Esta es la opción mas indicada en la mayoría de los casos, siempre que puedas deberías utilizar esta forma de realizar las consultas. Como parte negativa, en algunos casos en consultas más complejas la definición de los métodos puede extenderse demasiado dificultando la lectura del código.</p>
<p>De esto tenemos algún ejemplo por el tutorial, en el repositorio de <a href="./step5/#repository">GameRepository</a>.</p>
<p>Siguiendo el ejemplo del tutorial, si tuvieramos que recuperar los <code>Game</code> por el nombre del juego, se podría crear un método en el <code>GameRepository</code> de esta forma:</p>
<div class="highlight"><pre><span></span><code><span class="n">List</span><span class="o">&lt;</span><span class="n">Game</span><span class="o">&gt;</span> <span class="nf">findByName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">);</span>
</code></pre></div>
<p>Spring JPA entendería que quieres recuperar un listado de <code>Game</code> que están filtrados por su propiedad <code>Name</code> y generaría la consulta SQL de forma automática, sin tener que implementar nada.</p>
<p>Se pueden contruir muchos métodos diferentes, te recomiendo que leas un pequeño <a href="https://www.baeldung.com/spring-data-derived-queries">tutorial de Baeldung</a> y profundices con la <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation">documentación oficial</a>donde podrás ver todas las opciones.</p>
<h2 id="anotacion-query">Anotación @Query</h2>
<p>Otra forma de realizar consultas, esta vez menos automática y más cercana a SQL, es la anotación @Query.</p>
<p>Existen dos opciones a la hora de usar la anotación <code>@Query</code>. Esta anotación ya la hemos usado en el tutorial, dentro del <a href="../../develop/step5/#repository">GameRepository</a>.</p>
<p>En primer lugar tenemos las consultas JPQL. Estas guardan un parecido con el lenguaje SQL pero al igual que en el caso anterior, son traducidas por Spring JPA a la consulta final nativa. Su uso no está recomendado ya que estamos añadiendo un nivel de concreción y por tanto estamos aumentando la complejidad del código. Aun así, es otra forma de generar consultas.</p>
<p>Por otra parte, también es posible generar consultas nativas directamente dentro de esta anotación interactuando de forma directa con la base de datos. Esta práctica es altamente desaconsejable ya que crea acoplamientos con la tecnología de la BBDD utilizada y es una fuente de errores.</p>
<p>Puedes ver más información de esta anotación desde este pequeño <a href="https://www.baeldung.com/spring-data-jpa-query">tutorial de Baeldung</a>.</p>
<h2 id="acelerando-las-consultas">Acelerando las consultas</h2>
<p>En muchas ocasiones necesitamos obtener información que no está en una única tabla por motivos de diseño de la base de datos. Debemos plasmar esta casuística con cuidado a nuestro modelo relacional para obtener resultados óptimos en cuanto al rendimiento.</p>
<p>Para ilustrar el caso vamos a recuperar los objetos utilizados en el tutorial <code>Author</code>, <code>Gategory</code> y <code>Game</code>.
Si recuerdas, tenemos que un <code>Game</code> tiene asociado un <code>Author</code> y tiene asociada una <code>Gategory</code>.</p>
<p>Cuando utilizamos el método de filtrado <code>find</code> que construimos en el <code>GameRepository</code>, vemos que Spring JPA traduce la <code>@Query</code> que habíamos diseñado en una query SQL para recuperar los juegos.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Query</span><span class="p">(</span><span class="s">&quot;select g from Game g where (:title is null or g.title like &#39;%&#39;||:title||&#39;%&#39;) and (:category is null or g.category.id = :category)&quot;</span><span class="p">)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Game</span><span class="o">&gt;</span> <span class="nf">find</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">title</span><span class="p">,</span> <span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;category&quot;</span><span class="p">)</span> <span class="n">Long</span> <span class="n">category</span><span class="p">);</span>
</code></pre></div>
<p>Esta <code>@Query</code> es la que utiliza Spring JPA para traducir las propiedades a objetos de BBDD y mapear los resultados a objetos Java.
Si tenemos activada la property <code>spring.jpa.show-sql=true</code> podremos ver las queries que está generando Spring JPA. El resultado es el siguiente.</p>
<div class="highlight"><pre><span></span><code><span class="n">Hibernate</span><span class="p">:</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id1_2_</span><span class="p">,</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">age</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">age2_2_</span><span class="p">,</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">author_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">author_i4_2_</span><span class="p">,</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">category_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">category5_2_</span><span class="p">,</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">title3_2_</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="n">game0_</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="o">||?||</span><span class="s1">&#39;%&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">category_id</span><span class="o">=?</span><span class="p">)</span><span class="w"></span>
<span class="n">Hibernate</span><span class="p">:</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id1_0_0_</span><span class="p">,</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name2_0_0_</span><span class="p">,</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">nationality</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">national3_0_0_</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="n">author0_</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">id</span><span class="o">=?</span><span class="w"></span>
<span class="n">Hibernate</span><span class="p">:</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">category0_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id1_1_0_</span><span class="p">,</span><span class="w"> </span><span class="n">category0_</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name2_1_0_</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">category</span><span class="w"> </span><span class="n">category0_</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">category0_</span><span class="p">.</span><span class="n">id</span><span class="o">=?</span><span class="w"></span>
<span class="n">Hibernate</span><span class="p">:</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id1_0_0_</span><span class="p">,</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name2_0_0_</span><span class="p">,</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">nationality</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">national3_0_0_</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="n">author0_</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">id</span><span class="o">=?</span><span class="w"></span>
<span class="n">Hibernate</span><span class="p">:</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">category0_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id1_1_0_</span><span class="p">,</span><span class="w"> </span><span class="n">category0_</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name2_1_0_</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">category</span><span class="w"> </span><span class="n">category0_</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">category0_</span><span class="p">.</span><span class="n">id</span><span class="o">=?</span><span class="w"></span>
<span class="n">Hibernate</span><span class="p">:</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id1_0_0_</span><span class="p">,</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name2_0_0_</span><span class="p">,</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">nationality</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">national3_0_0_</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="n">author0_</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">id</span><span class="o">=?</span><span class="w"></span>
<span class="n">Hibernate</span><span class="p">:</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id1_0_0_</span><span class="p">,</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name2_0_0_</span><span class="p">,</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">nationality</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">national3_0_0_</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="n">author0_</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">id</span><span class="o">=?</span><span class="w"></span>
<span class="n">Hibernate</span><span class="p">:</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id1_0_0_</span><span class="p">,</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name2_0_0_</span><span class="p">,</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">nationality</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">national3_0_0_</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="n">author0_</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">author0_</span><span class="p">.</span><span class="n">id</span><span class="o">=?</span><span class="w"></span>
</code></pre></div>
<p>Si te fijas ha generado una query SQL para filtrar los <code>Game</code>, pero luego cuando ha intentado construir los objetos Java, ha tenido que lanzar una serie de queries para recuperar los diferentes <code>Author</code> y <code>Category</code> a través de sus <code>id</code>. Obviamente Spring JPA es muy lista y cachea los resultados obtenidos para no tener que recuperarlos n veces, pero aun así, lanza unas cuantas consultas. Esto penaliza el rendimiento de nuestra operación ya que tiene que lanzar n queries a BBDD que, aunque son muy óptimas, incrementan unos milisegundos el tiempo total.</p>
<p>Para evitar esta circunstancia, disponemos de la anotación denominada <code>@EnitityGraph</code> la cual proporciona directrices a Spring JPA sobre la forma en la que deseamos realizar la consulta, permitiendo que realice agrupaciones y uniones de tablas en una única query que, aun siendo mas compleja, en muchos casos el rendimiento es mucho mejor que realizar múltiples interacciones con la BBDD.</p>
<p>Siguiendo el ejemplo anterior podríamos utilizar la anotación de esta forma:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Query</span><span class="p">(</span><span class="s">&quot;select g from Game g where (:title is null or g.title like &#39;%&#39;||:title||&#39;%&#39;) and (:category is null or g.category.id = :category)&quot;</span><span class="p">)</span>
<span class="hll"><span class="nd">@EntityGraph</span><span class="p">(</span><span class="n">attributePaths</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;category&quot;</span><span class="p">,</span> <span class="s">&quot;author&quot;</span><span class="p">})</span>
</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Game</span><span class="o">&gt;</span> <span class="nf">find</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">title</span><span class="p">,</span> <span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;category&quot;</span><span class="p">)</span> <span class="n">Long</span> <span class="n">category</span><span class="p">);</span>
</code></pre></div>
<p>Donde le estamos diciendo a Spring JPA que cuando realice la query, haga el cruce con las propiedades <code>category</code> y <code>author</code>, que a su vez son entidades y por tanto mapean dos tablas de BBDD.
El resultado es el siguiente:</p>
<div class="highlight"><pre><span></span><code><span class="n">Hibernate</span><span class="p">:</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id1_2_0_</span><span class="p">,</span><span class="w"> </span><span class="n">category1_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id1_1_1_</span><span class="p">,</span><span class="w"> </span><span class="n">author2_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id1_0_2_</span><span class="p">,</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">age</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">age2_2_0_</span><span class="p">,</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">author_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">author_i4_2_0_</span><span class="p">,</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">category_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">category5_2_0_</span><span class="p">,</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">title3_2_0_</span><span class="p">,</span><span class="w"> </span><span class="n">category1_</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name2_1_1_</span><span class="p">,</span><span class="w"> </span><span class="n">author2_</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name2_0_2_</span><span class="p">,</span><span class="w"> </span><span class="n">author2_</span><span class="p">.</span><span class="n">nationality</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">national3_0_2_</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="n">game0_</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">outer</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">category</span><span class="w"> </span><span class="n">category1_</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">category_id</span><span class="o">=</span><span class="n">category1_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">outer</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="n">author2_</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">author_id</span><span class="o">=</span><span class="n">author2_</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="o">||?||</span><span class="s1">&#39;%&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">game0_</span><span class="p">.</span><span class="n">category_id</span><span class="o">=?</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Una única query, que es más compleja que la anterior ya que hace dos cruces con tablas de BBDD, pero que nos evita tener que lanzar n queries diferentes para recuperar <code>Author</code> y <code>Category</code>.</p>
<p>Generalmente, el uso de <code>@EntityGraph</code> acelera mucho los resultados y es muy recomendable utilizarlo para realizar los cruces inline. Se puede utilizar tanto con <code>@Query</code> como con <code>Derived Query Methods</code>. Puedes leer más información en este pequeño <a href="https://www.baeldung.com/jpa-entity-graph">tutorial de Baeldung</a>.</p>
<h2 id="alternativa-de-streams">Alternativa de Streams</h2>
<p>A partir de Java 8 disponemos de los Java Streams. Se trata de una herramienta que nos permite multitud de opciones relativas tratamiento y trasformación de los datos manejados.</p>
<p>En este apartado únicamente se menciona debido a que en muchas ocasiones cuando nos enfrentamos a consultas complejas, puede ser beneficioso evitar ofuscar las consultas y realizar las trasformaciones necesarias mediante los Streams.</p>
<p>Un ejemplo de uso practico podría ser, evitar usar la cláusula <code>IN</code> de SQL en una determinada consulta que podría penalizar notablemente el rendimiento de las consultas. En vez de eso se podría utilizar el método de JAVA <code>filter</code> sobre el conjunto de elementos para obtener el mismo resultado.</p>
<p>Puedes leer más información en el <a href="https://www.baeldung.com/java-8-streams">tutorial de Baeldung</a>.</p>
<h2 id="repository-custom">Repository Custom</h2>
<div class="admonition warning">
<p class="admonition-title">Atención</p>
<p>Este punto falta por desarrollar.</p>
</div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Pie">
      
        
        <a href="../tdd/" class="md-footer__link md-footer__link--prev" aria-label="Anterior: Anexo. TDD" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              Anexo. TDD
            </div>
          </div>
        </a>
      
      
        
        <a href="../../develop/step6/" class="md-footer__link md-footer__link--next" aria-label="Siguiente: Anexo. Validaciones (TBC)" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Siguiente
              </span>
              Anexo. Validaciones (TBC)
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copiar al portapapeles", "clipboard.copied": "Copiado al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "B\u00fasqueda", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.term.missing": "Falta", "select.version.title": "Seleccionar versi\u00f3n"}, "search": "../../assets/javascripts/workers/search.22074ed6.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.960e086b.min.js"></script>
      
    
  </body>
</html>